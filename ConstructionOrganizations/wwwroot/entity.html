<!DOCTYPE html>
<html>
<head>
    <title>CRUD: Employee</title>
</head>
<body>
    <button onclick="registration()">Регистрация</button>
    <button onclick="authorization()">Авторизироваться</button>

    <div id="createForm">
        <h2>Добавить нового сотрудника</h2>
        <input id="newName" placeholder="Имя"><br><br>
        <input id="newLastName" placeholder="Фамилия"><br><br>
        <input id="newEmployeeTypeId" placeholder="ID типа сотрудника"><br><br>
        <input id="newPositionId" placeholder="ID должности"><br><br>
        <input id="newProjectId" placeholder="ID проекта"><br><br>
        <input id="newBrigadeId" placeholder="ID бригады"><br><br>
        <button onclick="create()">Сохранить</button>
    </div>

    <h2>Список сотрудников</h2>
    <div id="employeesList"></div>

    <script>
        const api = "http://localhost:5000/api";

        async function authorization() {
            window.location.href = "http://localhost:5000/login.html";
        }

        async function registration() {
            window.location.href = "http://localhost:5000/registration.html";
        }

        async function loadEmployees() {
            const res = await fetch(`${api}/employees/all?count=20`);
            const employees = await res.json();
            const list = document.getElementById("employeesList");
            list.innerHTML = "";

            employees.forEach(emp => {
                const div = document.createElement("div");

                div.innerHTML = `
                        <pre>${JSON.stringify(emp, null, 2)}</pre>
                        <button onclick='edit(${parseInt(emp.id) })'>Редактировать</button>
                        <button onclick='remove(${parseInt(emp.id)})'>Удалить</button>
                    `;

                list.appendChild(div);
            });
        }

        async function create() {
            const name = document.getElementById("newName").value;
            const lastName = document.getElementById("newLastName").value;
            const employeeTypeId = parseInt(document.getElementById("newEmployeeTypeId").value) || null;
            const positionId = parseInt(document.getElementById("newPositionId").value) || null;
            const projectId = parseInt(document.getElementById("newProjectId").value) || null;
            const brigadeId = parseInt(document.getElementById("newBrigadeId").value) || null;
            const token = sessionStorage.getItem("auth_token");

            await fetch(`${api}/employees/post`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    FirstName: name,
                    LastName: lastName,
                    EmployeeTypeId: employeeTypeId,
                    PositionId: positionId,
                    ProjectId: projectId,
                    BrigadeId: brigadeId
                })
            });

            loadEmployees();
        }

        async function remove(id) {
            var res = await fetch(`${api}/delete?id=${id}&entity=employees`,
                {
                    method: "DELETE"
                });

            loadEmployees();
        }

        async function edit(id) {

            sessionStorage.setItem("idEdit", id);
            window.location.href = "http://localhost:5000/edit.html";
            loadEmployees();
        }

        window.onload = loadEmployees;
    </script>

</body>
</html>